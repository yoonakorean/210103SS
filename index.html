<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>句子跟讀挑戰</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; text-align: center; padding: 30px 15px; }
    #question-box { margin: 20px 0; }
    #user-audio.hidden { display: none; }
    button { margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h1 id="title">1-1 句子跟讀挑戰</h1>
  <div id="question-box">
    <p id="question-text"></p>
    <p id="keywords"></p>
    <p><span id="current-number"></span> / <span id="total-number"></span></p>
    <audio id="audio-player" controls></audio>
  </div>
  <audio id="user-audio" controls class="hidden"></audio>
  <div>
    <button id="start-btn">🎤 開始錄音</button>
    <button id="stop-btn" disabled>⏹ 停止錄音</button>
    <button id="toggle-pro-mode">切換 Pro 模式</button>
  </div>

  <script>
    const questions = [
      { text: "아침에 보통 커피를 마시거나 빵을 먹어요.", keywords: "커피, 빵", audio: "audio1.mp3" },
      { text: "주말에 시간이 있으면 보통 집에서 청소하거나 음악을 들어요.", keywords: "주말, 청소, 음악", audio: "audio2.mp3" }
    ];

    let currentQuestion = 0;
    let isProMode = false;

    const questionText = document.getElementById("question-text");
    const keywordsDiv = document.getElementById("keywords");
    const currentNumberSpan = document.getElementById("current-number");
    const totalNumberSpan = document.getElementById("total-number");
    const audioPlayer = document.getElementById("audio-player");
    const userAudio = document.getElementById("user-audio");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const proModeBtn = document.getElementById("toggle-pro-mode");

    totalNumberSpan.textContent = questions.length;

    // 🎧 建立共用 AudioContext
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let trackConnected = false;
    let userTrackConnected = false;

    function connectWithGain(element, gainValue, alreadyConnectedFlag) {
      if (!alreadyConnectedFlag.flag) {
        const source = audioCtx.createMediaElementSource(element);
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = gainValue;
        source.connect(gainNode).connect(audioCtx.destination);
        alreadyConnectedFlag.flag = true;
      }
    }

    function showQuestion() {
      const q = questions[currentQuestion];
      questionText.textContent = q.text;
      keywordsDiv.textContent = `[${q.keywords}]`;
      currentNumberSpan.textContent = currentQuestion + 1;
      audioPlayer.src = q.audio;
      userAudio.classList.add("hidden");
      userAudio.src = "";

      questionText.style.visibility = isProMode ? "hidden" : "visible";
      keywordsDiv.style.visibility = isProMode ? "hidden" : "visible";
    }

    showQuestion();

    // 🟢 確保點播放時才建立聲音管道
    audioPlayer.addEventListener("play", () => {
      audioCtx.resume();
      connectWithGain(audioPlayer, 2, { get flag() { return trackConnected; }, set flag(v) { trackConnected = v; } });
    });

    userAudio.addEventListener("play", () => {
      audioCtx.resume();
      connectWithGain(userAudio, 2, { get flag() { return userTrackConnected; }, set flag(v) { userTrackConnected = v; } });
    });

    // Pro 模式
    proModeBtn.addEventListener("click", () => {
      isProMode = !isProMode;
      showQuestion();
    });

    // 偽造錄音流程（示範用）
    startBtn.addEventListener("click", () => {
      startBtn.disabled = true;
      stopBtn.disabled = false;
      console.log("開始錄音...");
    });

    stopBtn.addEventListener("click", () => {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      console.log("停止錄音，生成回放...");
      userAudio.src = "recorded.mp3"; // 假裝錄到音
      userAudio.classList.remove("hidden");
    });
  </script>
</body>
</html>
